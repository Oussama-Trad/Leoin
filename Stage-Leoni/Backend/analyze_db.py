#!/usr/bin/env python3
"""
Script d'analyse de la base de donn√©es MongoDB pour diagnostiquer les probl√®mes de chat
"""

from pymongo import MongoClient
import os
from dotenv import load_dotenv
import json
from datetime import datetime

def analyze_database():
    # Charger les variables d'environnement
    load_dotenv()
    MONGODB_URI = os.getenv('MONGODB_URI', 'mongodb+srv://oussamatrzd19:oussama123@leoniapp.grhnzgz.mongodb.net/LeoniApp')

    try:
        client = MongoClient(MONGODB_URI)
        db = client.LeoniApp
        
        print('üîç ANALYSE DE LA BASE DE DONN√âES MONGODB üîç')
        print('=' * 60)
        
        # Collections existantes
        collections = db.list_collection_names()
        print(f'üìÅ Collections disponibles: {collections}')
        
        # ========================================
        # ANALYSE DES CHATS
        # ========================================
        chats_count = db.chats.count_documents({})
        print(f'\nüí¨ CHATS ({chats_count} total)')
        print('-' * 40)
        
        if chats_count > 0:
            # Premier chat pour voir la structure
            sample_chat = db.chats.find_one()
            print('üìã Structure d\'un chat:')
            for key, value in sample_chat.items():
                if key != '_id':
                    print(f'  {key}: {type(value).__name__} = {value}')
            
            # Statistiques par d√©partement et location (ancienne structure)
            print('\nüìä Chats par service/cat√©gorie:')
            pipeline = [
                {'$group': {
                    '_id': {
                        'category': '$category',
                        'service': '$participants.service.serviceName'
                    },
                    'count': {'$sum': 1}
                }},
                {'$sort': {'count': -1}}
            ]
            dept_stats = list(db.chats.aggregate(pipeline))
            for stat in dept_stats:
                category = stat['_id']['category'] or 'Unknown'
                service = stat['_id']['service'] or 'Unknown'
                count = stat['count']
                print(f'  {category} ({service}): {count} chats')
            
            # V√©rifier s'il y a des chats avec la nouvelle structure
            new_structure_count = db.chats.count_documents({'targetDepartment': {'$exists': True}})
            print(f'\nüìä Chats avec nouvelle structure (targetDepartment): {new_structure_count}')
            
            # Statistiques par statut
            print('\nüìà Chats par statut:')
            status_pipeline = [
                {'$group': {
                    '_id': '$status',
                    'count': {'$sum': 1}
                }},
                {'$sort': {'count': -1}}
            ]
            status_stats = list(db.chats.aggregate(status_pipeline))
            for stat in status_stats:
                status = stat['_id'] or 'None'
                count = stat['count']
                print(f'  {status}: {count} chats')
        else:
            print('‚ö†Ô∏è Aucun chat trouv√© dans la base de donn√©es!')
        
        # ========================================
        # ANALYSE DES MESSAGES
        # ========================================
        messages_count = db.chat_messages.count_documents({})
        print(f'\nüíå CHAT_MESSAGES ({messages_count} total)')
        print('-' * 40)
        
        if messages_count > 0:
            # Premier message pour voir la structure
            sample_message = db.chat_messages.find_one()
            print('üìã Structure d\'un message:')
            for key, value in sample_message.items():
                if key != '_id':
                    print(f'  {key}: {type(value).__name__} = {value}')
            
            # V√©rifier les champs de r√©f√©rence au chat
            messages_with_chatRef = db.chat_messages.count_documents({'chatRef': {'$exists': True}})
            messages_with_chatId = db.chat_messages.count_documents({'chatId': {'$exists': True}})
            print(f'\nüîó R√©f√©rences aux chats:')
            print(f'  Messages avec chatRef: {messages_with_chatRef}')
            print(f'  Messages avec chatId: {messages_with_chatId}')
            
            # Compter les messages par r√¥le d'exp√©diteur
            print(f'\nüë• Messages par r√¥le:')
            role_pipeline = [
                {'$group': {
                    '_id': '$senderRole',
                    'count': {'$sum': 1}
                }},
                {'$sort': {'count': -1}}
            ]
            role_stats = list(db.chat_messages.aggregate(role_pipeline))
            for stat in role_stats:
                role = stat['_id'] or 'None'
                count = stat['count']
                print(f'  {role}: {count} messages')
                
            # V√©rifier la coh√©rence des r√©f√©rences
            print(f'\nüîç V√©rification coh√©rence:')
            # Messages orphelins (qui r√©f√©rencent des chats inexistants)
            all_chat_ids = set(str(chat['_id']) for chat in db.chats.find({}, {'_id': 1}))
            
            orphan_messages = 0
            for message in db.chat_messages.find({'chatRef': {'$exists': True}}, {'chatRef': 1}):
                chat_ref = str(message.get('chatRef', ''))
                if chat_ref not in all_chat_ids:
                    orphan_messages += 1
            
            print(f'  Messages orphelins (chatRef invalide): {orphan_messages}')
            
        else:
            print('‚ö†Ô∏è Aucun message trouv√© dans la base de donn√©es!')
        
        # ========================================
        # ANALYSE DES ADMINS
        # ========================================
        admins_count = db.admins.count_documents({})
        print(f'\nüë§ ADMINS ({admins_count} total)')
        print('-' * 40)
        
        if admins_count > 0:
            # Premier admin pour voir la structure
            sample_admin = db.admins.find_one()
            print('üìã Structure d\'un admin:')
            for key, value in sample_admin.items():
                if key not in ['_id', 'password']:  # Ne pas afficher le mot de passe
                    print(f'  {key}: {type(value).__name__} = {value}')
            
            # Admins par d√©partement et location
            print(f'\nüìä Admins par d√©partement:')
            admin_pipeline = [
                {'$group': {
                    '_id': {
                        'department': '$department',
                        'location': '$location'
                    },
                    'count': {'$sum': 1}
                }},
                {'$sort': {'count': -1}}
            ]
            admin_stats = list(db.admins.aggregate(admin_pipeline))
            for stat in admin_stats:
                dept = stat['_id']['department'] or 'Unknown'
                loc = stat['_id']['location'] or 'Unknown'
                count = stat['count']
                print(f'  {dept} ({loc}): {count} admins')
        else:
            print('‚ö†Ô∏è Aucun admin trouv√© dans la base de donn√©es!')
        
        # ========================================
        # ANALYSE DES D√âPARTEMENTS
        # ========================================
        departments_count = db.departments.count_documents({})
        print(f'\nüè¢ DEPARTMENTS ({departments_count} total)')
        print('-' * 40)
        
        if departments_count > 0:
            departments = list(db.departments.find({}))
            for dept in departments[:10]:  # Montrer les 10 premiers
                name = dept.get('name', 'Unknown')
                location = dept.get('location', 'Unknown')
                active = dept.get('active', True)
                print(f'  {name} ({location}) - Active: {active}')
        else:
            print('‚ö†Ô∏è Aucun d√©partement trouv√© dans la base de donn√©es!')
        
        # ========================================
        # DIAGNOSTIC DES PROBL√àMES
        # ========================================
        print(f'\nüîç DIAGNOSTIC DES PROBL√àMES')
        print('=' * 60)
        
        problems = []
        
        # Probl√®me 1: Incoh√©rence dans les champs chatId vs chatRef
        if messages_count > 0:
            if messages_with_chatRef == 0 and messages_with_chatId > 0:
                problems.append("‚ùå Tous les messages utilisent 'chatId' au lieu de 'chatRef'")
            elif messages_with_chatRef > 0 and messages_with_chatId > 0:
                problems.append("‚ö†Ô∏è Certains messages utilisent 'chatId', d'autres 'chatRef'")
            elif messages_with_chatRef == 0 and messages_with_chatId == 0:
                problems.append("‚ùå Aucun message n'a de r√©f√©rence vers un chat")
        
        # Probl√®me 2: Messages orphelins
        if orphan_messages > 0:
            problems.append(f"‚ùå {orphan_messages} messages orphelins (r√©f√©rences invalides)")
        
        # Probl√®me 3: Sch√©ma de donn√©es incoh√©rent
        if chats_count > 0:
            # V√©rifier les diff√©rentes structures de chats
            old_structure_count = db.chats.count_documents({'participants.service': {'$exists': True}})
            new_structure_count = db.chats.count_documents({'targetDepartment': {'$exists': True}})
            
            if old_structure_count > 0 and new_structure_count == 0:
                problems.append(f"‚ùå Tous les chats ({old_structure_count}) utilisent l'ancienne structure (service/participants)")
            elif old_structure_count > 0 and new_structure_count > 0:
                problems.append(f"‚ö†Ô∏è Structure mixte: {old_structure_count} anciens chats, {new_structure_count} nouveaux")
        
        # Probl√®me 4: Pas d'admin dans la bonne location/d√©partement (pour nouvelle structure seulement)
        if new_structure_count > 0 and admins_count > 0:
            # V√©rifier s'il y a des admins pour chaque d√©partement/location ayant des chats
            chat_departments = set()
            for chat in db.chats.find({'targetDepartment': {'$exists': True}}, {'targetDepartment': 1, 'targetLocation': 1}):
                dept = chat.get('targetDepartment')
                loc = chat.get('targetLocation')
                if dept and loc:
                    chat_departments.add((dept, loc))
            
            admin_departments = set()
            for admin in db.admins.find({}, {'department': 1, 'location': 1}):
                dept = admin.get('department')
                loc = admin.get('location')
                if dept and loc:
                    admin_departments.add((dept, loc))
            
            uncovered_departments = chat_departments - admin_departments
            if uncovered_departments:
                problems.append(f"‚ö†Ô∏è D√©partements sans admin: {list(uncovered_departments)}")
        
        # Probl√®me 5: Pas de d√©partements d√©finis
        if departments_count == 0:
            problems.append("‚ùå Aucun d√©partement d√©fini dans la collection 'departments'")
        
        if problems:
            print("PROBL√àMES D√âTECT√âS:")
            for problem in problems:
                print(f"  {problem}")
        else:
            print("‚úÖ Aucun probl√®me d√©tect√©!")
        
        # ========================================
        # SOLUTIONS PROPOS√âES
        # ========================================
        if problems:
            print(f'\nüîß SOLUTIONS PROPOS√âES')
            print('=' * 60)
            
            if "chatId" in str(problems):
                print("1. Migration des champs chatId vers chatRef:")
                print("   db.chat_messages.updateMany({chatId: {$exists: true}}, [{$set: {chatRef: '$chatId'}}, {$unset: 'chatId'}])")
            
            if "ancienne structure" in str(problems):
                print("2. Migration du sch√©ma de chats:")
                print("   Convertir les chats de l'ancienne structure (service/participants) vers la nouvelle (targetDepartment/targetLocation)")
            
            if orphan_messages > 0:
                print("3. Nettoyer les messages orphelins:")
                print("   Identifier et supprimer les messages sans chat valide")
            
            if 'uncovered_departments' in locals() and uncovered_departments:
                print("4. Cr√©er des admins pour les d√©partements manquants")
            
            if departments_count == 0:
                print("5. Initialiser la collection departments avec les d√©partements standard")
        
        print(f'\n‚úÖ Analyse termin√©e!')
        
    except Exception as e:
        print(f'‚ùå Erreur lors de l\'analyse: {e}')
        import traceback
        traceback.print_exc()

if __name__ == '__main__':
    analyze_database()
