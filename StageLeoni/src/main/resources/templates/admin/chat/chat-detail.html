<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conversation - LeoniApp Admin</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        .chat-container {
            height: 60vh;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background-color: #f8f9fa;
        }
        .message {
            margin-bottom: 1rem;
            padding: 0.75rem;
        }
        .message.user {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            margin-right: 2rem;
        }
        .message.admin {
            background-color: #f3e5f5;
            border-left: 4px solid #9c27b0;
            margin-left: 2rem;
        }
        .message.superadmin {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
            margin-left: 2rem;
        }
        .message-header {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 0.5rem;
        }
        .message-content {
            font-size: 0.95rem;
            line-height: 1.4;
        }
        .reply-section {
            background-color: #ffffff;
            border-top: 1px solid #dee2e6;
            padding: 1rem;
        }
        .status-badge {
            font-size: 0.9rem;
        }
        .chat-info-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .action-buttons .btn {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .loading-reply {
            display: none;
        }
        .timestamp {
            font-size: 0.75rem;
            color: #6c757d;
        }
        .message-edited {
            font-style: italic;
            color: #6c757d;
            font-size: 0.8rem;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/dashboard">
                <i class="fas fa-cog me-2"></i>LeoniApp Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin/dashboard">
                    <i class="fas fa-home me-1"></i>Tableau de bord
                </a>
                <a class="nav-link" href="/admin/chat">
                    <i class="fas fa-comments me-1"></i>Conversations
                </a>
                <a class="nav-link" href="/admin/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>Déconnexion
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- En-tête -->
        <div class="row mb-4">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/admin/dashboard">Tableau de bord</a></li>
                        <li class="breadcrumb-item"><a href="/admin/chat">Conversations</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Détail</li>
                    </ol>
                </nav>
                
                <h1 class="h3 mb-0" th:if="${chat}">
                    <i class="fas fa-comment text-primary me-2"></i>
                    <span th:text="${chat.subject}">Sujet de la conversation</span>
                </h1>
            </div>
        </div>

        <!-- Messages d'erreur -->
        <div class="alert alert-danger" role="alert" th:if="${error}">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span th:text="${error}">Erreur</span>
        </div>

        <!-- Contenu principal -->
        <div class="row" th:if="${chat}">
            <!-- Informations de la conversation -->
            <div class="col-md-4 mb-4">
                <div class="card chat-info-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            Informations
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <strong>Statut:</strong>
                                <span class="badge status-badge ms-2" 
                                      th:text="${chat.status}" 
                                      th:classappend="${chat.status == 'open'} ? 'bg-warning text-dark' : (${chat.status == 'in_progress'} ? 'bg-primary' : 'bg-success')">
                                    Status
                                </span>
                            </div>
                            <div class="col-12 mb-3">
                                <strong>Priorité:</strong>
                                <i class="fas fa-flag ms-2" 
                                   th:classappend="${chat.priority == 'high'} ? 'text-danger' : (${chat.priority == 'medium'} ? 'text-warning' : 'text-success')"
                                   th:title="${chat.priority}"></i>
                                <span th:text="${chat.priority}" class="ms-1">Priorité</span>
                            </div>
                            <div class="col-12 mb-3">
                                <strong>Employé:</strong><br>
                                <span th:text="${chat.userName}">Nom utilisateur</span><br>
                                <small th:text="${chat.userEmail}">email@example.com</small>
                            </div>
                            <div class="col-12 mb-3">
                                <strong>Département:</strong><br>
                                <span th:text="${chat.userDepartment}">Département</span>
                            </div>
                            <div class="col-12 mb-3">
                                <strong>Location:</strong><br>
                                <span th:text="${chat.userLocation}">Location</span>
                            </div>
                            <div class="col-12 mb-3">
                                <strong>Créée le:</strong><br>
                                <span th:text="${#temporals.format(chat.createdAt, 'dd/MM/yyyy HH:mm')}">Date création</span>
                            </div>
                            <div class="col-12 mb-3">
                                <strong>Dernière activité:</strong><br>
                                <span th:text="${#temporals.format(chat.lastActivityAt, 'dd/MM/yyyy HH:mm')}">Dernière activité</span>
                            </div>
                            <div class="col-12 mb-3" th:if="${chat.assignedAdminName}">
                                <strong>Admin assigné:</strong><br>
                                <span th:text="${chat.assignedAdminName}">Admin</span>
                            </div>
                            <div class="col-12">
                                <strong>Messages:</strong>
                                <span th:text="${messageCount}">0</span>
                                <small class="text-white-50" th:if="${unreadCount > 0}">
                                    (<span th:text="${unreadCount}">0</span> non lus)
                                </small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-tools me-2"></i>
                            Actions
                        </h6>
                    </div>
                    <div class="card-body action-buttons">
                        <button type="button" class="btn btn-warning btn-sm" 
                                onclick="updateStatus('in_progress')"
                                th:disabled="${chat.status == 'in_progress'}">
                            <i class="fas fa-play me-1"></i>Prendre en charge
                        </button>
                        <button type="button" class="btn btn-success btn-sm" 
                                onclick="updateStatus('closed')"
                                th:disabled="${chat.status == 'closed'}">
                            <i class="fas fa-check me-1"></i>Fermer
                        </button>
                        <button type="button" class="btn btn-secondary btn-sm" 
                                onclick="updateStatus('open')"
                                th:disabled="${chat.status == 'open'}">
                            <i class="fas fa-undo me-1"></i>Rouvrir
                        </button>
                        <button type="button" class="btn btn-info btn-sm" onclick="refreshConversation()">
                            <i class="fas fa-sync-alt me-1"></i>Actualiser
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="assignToMe()">
                            <i class="fas fa-user-plus me-1"></i>M'assigner
                        </button>
                    </div>
                </div>
            </div>

            <!-- Messages de la conversation -->
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-comments me-2"></i>
                            Messages
                        </h5>
                        <small class="text-muted">
                            <span th:text="${messageCount}">0</span> message(s)
                        </small>
                    </div>
                    
                    <!-- Zone des messages -->
                    <div class="chat-container p-3" id="messagesContainer">
                        <div th:if="${messages != null and !messages.isEmpty()}">
                            <div th:each="message : ${messages}" 
                                 class="message" 
                                 th:classappend="${message.senderType}">
                                <div class="message-header">
                                    <strong th:text="${message.senderName}">Expéditeur</strong>
                                    <span class="badge badge-sm ms-2" 
                                          th:text="${message.senderType}"
                                          th:classappend="${message.senderType == 'user'} ? 'bg-info' : (${message.senderType == 'admin'} ? 'bg-purple' : 'bg-warning text-dark')">
                                        Type
                                    </span>
                                    <span class="timestamp float-end" th:text="${#temporals.format(message.createdAt, 'dd/MM/yyyy HH:mm:ss')}">
                                        Timestamp
                                    </span>
                                </div>
                                <div class="message-content" th:text="${message.message}">
                                    Contenu du message
                                </div>
                                <div class="message-edited" th:if="${message.edited}">
                                    <i class="fas fa-edit me-1"></i>
                                    Modifié le <span th:text="${#temporals.format(message.editedAt, 'dd/MM/yyyy HH:mm')}">date</span>
                                </div>
                            </div>
                        </div>
                        
                        <div th:if="${messages == null or messages.isEmpty()}" class="text-center py-4">
                            <i class="fas fa-comment-slash fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Aucun message dans cette conversation</p>
                        </div>
                    </div>

                    <!-- Zone de réponse -->
                    <div class="reply-section">
                        <form id="replyForm" onsubmit="sendReply(event)">
                            <div class="mb-3">
                                <label for="replyMessage" class="form-label">
                                    <i class="fas fa-reply me-1"></i>Votre réponse
                                </label>
                                <textarea class="form-control" id="replyMessage" rows="3" 
                                          placeholder="Tapez votre réponse ici..." required></textarea>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Votre réponse sera envoyée à l'employé par email
                                </small>
                                <div>
                                    <button type="button" class="btn btn-secondary me-2" onclick="clearReply()">
                                        <i class="fas fa-times me-1"></i>Annuler
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-paper-plane me-1"></i>Envoyer
                                    </button>
                                </div>
                            </div>
                        </form>
                        
                        <!-- Indicateur de chargement -->
                        <div class="loading-reply text-center py-3" id="loadingReply">
                            <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                <span class="visually-hidden">Envoi...</span>
                            </div>
                            Envoi de la réponse...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const chatId = /*[[${chat?.id}]]*/ '';
        /*]]*/
        
        // Faire défiler vers le bas des messages
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }
        
        // Initialiser le scroll
        document.addEventListener('DOMContentLoaded', function() {
            scrollToBottom();
        });

        // Envoyer une réponse
        async function sendReply(event) {
            event.preventDefault();
            
            const messageTextarea = document.getElementById('replyMessage');
            const message = messageTextarea.value.trim();
            
            if (!message) {
                alert('Veuillez saisir un message');
                return;
            }
            
            const loadingReply = document.getElementById('loadingReply');
            const replyForm = document.getElementById('replyForm');
            
            try {
                // Afficher le loading
                replyForm.style.display = 'none';
                loadingReply.style.display = 'block';
                
                const response = await fetch(`/admin/chat/api/${chatId}/reply`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Vider le textarea
                    messageTextarea.value = '';
                    
                    // Recharger la conversation
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                    
                    showSuccess('Réponse envoyée avec succès!');
                } else {
                    showError('Erreur lors de l\'envoi: ' + data.error);
                }
                
            } catch (error) {
                showError('Erreur de connexion: ' + error.message);
            } finally {
                // Masquer le loading
                loadingReply.style.display = 'none';
                replyForm.style.display = 'block';
            }
        }

        // Mettre à jour le statut
        async function updateStatus(newStatus) {
            if (!confirm(`Êtes-vous sûr de vouloir changer le statut vers "${newStatus}" ?`)) {
                return;
            }
            
            try {
                const response = await fetch(`/admin/chat/api/${chatId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess('Statut mis à jour avec succès!');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    showError('Erreur lors de la mise à jour: ' + data.error);
                }
                
            } catch (error) {
                showError('Erreur de connexion: ' + error.message);
            }
        }

        // S'assigner la conversation
        async function assignToMe() {
            // Récupérer l'ID admin depuis la session (à implémenter selon votre système)
            // Pour l'instant on va juste recharger
            if (confirm('Voulez-vous vous assigner cette conversation ?')) {
                location.reload();
            }
        }

        // Actualiser la conversation
        function refreshConversation() {
            location.reload();
        }

        // Vider la zone de réponse
        function clearReply() {
            document.getElementById('replyMessage').value = '';
        }

        // Fonctions utilitaires pour les notifications
        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showError(message) {
            showNotification(message, 'danger');
        }

        function showNotification(message, type) {
            // Créer la notification
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';
            
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Supprimer après 5 secondes
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Auto-refresh toutes les 30 secondes
        setInterval(() => {
            // Vérifier s'il y a de nouveaux messages (sans recharger complètement)
            checkForNewMessages();
        }, 30000);

        async function checkForNewMessages() {
            try {
                const response = await fetch(`/admin/chat/api/${chatId}`);
                const data = await response.json();
                
                if (data.success) {
                    const currentMessageCount = parseInt(document.querySelector('.card-header small').textContent);
                    if (data.messageCount > currentMessageCount) {
                        // Il y a de nouveaux messages
                        const refreshBtn = document.createElement('div');
                        refreshBtn.className = 'alert alert-info alert-dismissible fade show position-fixed';
                        refreshBtn.style.top = '70px';
                        refreshBtn.style.right = '20px';
                        refreshBtn.style.zIndex = '9999';
                        refreshBtn.innerHTML = `
                            <i class="fas fa-sync-alt me-2"></i>
                            Nouveaux messages disponibles
                            <button type="button" class="btn btn-sm btn-outline-info ms-2" onclick="location.reload()">Actualiser</button>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        `;
                        document.body.appendChild(refreshBtn);
                    }
                }
            } catch (error) {
                // Ignorer les erreurs de vérification silencieuse
            }
        }
    </script>
</body>
</html>
