<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Conversations - LeoniApp Admin</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Custom CSS -->
    <style>
        .chat-card {
            transition: transform 0.2s ease-in-out;
            border-left: 4px solid #dee2e6;
        }
        .chat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .chat-card.status-open {
            border-left-color: #ffc107;
        }
        .chat-card.status-in_progress {
            border-left-color: #0d6efd;
        }
        .chat-card.status-closed {
            border-left-color: #198754;
        }
        .priority-high {
            color: #dc3545;
        }
        .priority-medium {
            color: #ffc107;
        }
        .priority-low {
            color: #198754;
        }
        .unread-badge {
            background-color: #dc3545;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .search-box {
            background-color: #f8f9fa;
        }
        .loading {
            display: none;
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand" href="/admin/dashboard">
                <i class="fas fa-cog me-2"></i>LeoniApp Admin
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/admin/dashboard">
                    <i class="fas fa-home me-1"></i>Tableau de bord
                </a>
                <a class="nav-link active" href="/admin/chat">
                    <i class="fas fa-comments me-1"></i>Conversations
                </a>
                <a class="nav-link" href="/admin/logout">
                    <i class="fas fa-sign-out-alt me-1"></i>Déconnexion
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <!-- En-tête avec statistiques -->
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="h3 mb-3">
                    <i class="fas fa-comments text-primary me-2"></i>
                    Gestion des Conversations
                </h1>
                
                <!-- Statistiques -->
                <div class="row" th:if="${statistics}">
                    <div class="col-md-3 mb-3">
                        <div class="card stats-card">
                            <div class="card-body text-center">
                                <i class="fas fa-comments fa-2x mb-2"></i>
                                <h5 class="card-title" th:text="${statistics.totalChats}">0</h5>
                                <p class="card-text">Total Conversations</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-warning text-dark">
                            <div class="card-body text-center">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <h5 class="card-title" th:text="${statistics.activeChats}">0</h5>
                                <p class="card-text">Conversations Actives</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                                <h5 class="card-title" th:text="${statistics.unreadChats}">0</h5>
                                <p class="card-text">Non Lues</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-calendar-day fa-2x mb-2"></i>
                                <h5 class="card-title" th:text="${statistics.chatsLast24h}">0</h5>
                                <p class="card-text">Dernières 24h</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtres et recherche -->
        <div class="row mb-3">
            <div class="col-md-8">
                <div class="card search-box">
                    <div class="card-body">
                        <form method="GET" action="/admin/chat" class="row g-3">
                            <div class="col-md-4">
                                <label for="status" class="form-label">Filtrer par statut</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="">Tous les statuts</option>
                                    <option value="open" th:selected="${selectedStatus == 'open'}">Ouvert</option>
                                    <option value="in_progress" th:selected="${selectedStatus == 'in_progress'}">En cours</option>
                                    <option value="closed" th:selected="${selectedStatus == 'closed'}">Fermé</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="search" class="form-label">Rechercher</label>
                                <input type="text" class="form-control" id="search" placeholder="Sujet, utilisateur...">
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-filter me-1"></i>Filtrer
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="location.reload()">
                                    <i class="fas fa-sync-alt me-1"></i>Actualiser
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card h-100">
                    <div class="card-body d-flex align-items-center">
                        <div>
                            <h6 class="card-title mb-1">Pagination</h6>
                            <p class="card-text small text-muted" th:text="|Affichage de ${currentPage * pageSize + 1} à ${currentPage * pageSize + chats.numberOfElements} sur ${totalElements} conversations|">
                                Affichage des conversations
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Messages d'erreur -->
        <div class="alert alert-danger" role="alert" th:if="${error}">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span th:text="${error}">Erreur</span>
        </div>

        <!-- Loading indicator -->
        <div class="text-center loading" id="loadingIndicator">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Chargement...</span>
            </div>
            <p class="mt-2">Chargement des conversations...</p>
        </div>

        <!-- Liste des conversations -->
        <div class="row" id="conversationsList">
            <div class="col-12" th:if="${chats != null and !chats.isEmpty()}">
                <div class="row">
                    <div class="col-md-6 col-lg-4 mb-3" th:each="chat : ${chats}">
                        <div class="card chat-card h-100" 
                             th:classappend="|status-${chat.status}|"
                             th:onclick="|viewConversation('${chat.id}')|">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0" th:text="${chat.subject}">Sujet de la conversation</h6>
                                <div>
                                    <span class="badge bg-secondary" th:text="${chat.status}" th:classappend="${chat.status == 'open'} ? 'bg-warning text-dark' : (${chat.status == 'in_progress'} ? 'bg-primary' : 'bg-success')">Status</span>
                                    <span class="badge unread-badge ms-1" th:if="${chat.hasUnreadMessages}">
                                        <i class="fas fa-circle"></i>
                                    </span>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-8">
                                        <p class="card-text">
                                            <strong>Employé:</strong> <span th:text="${chat.userName}">Nom utilisateur</span><br>
                                            <strong>Email:</strong> <span th:text="${chat.userEmail}">email@example.com</span><br>
                                            <strong>Département:</strong> <span th:text="${chat.userDepartment}">Département</span><br>
                                            <strong>Location:</strong> <span th:text="${chat.userLocation}">Location</span>
                                        </p>
                                    </div>
                                    <div class="col-4 text-end">
                                        <i class="fas fa-flag" th:classappend="${chat.priority == 'high'} ? 'priority-high' : (${chat.priority == 'medium'} ? 'priority-medium' : 'priority-low')" th:title="${chat.priority}"></i>
                                        <br><br>
                                        <small class="text-muted">
                                            <i class="fas fa-envelope me-1"></i><span th:text="${chat.messageCount}">0</span>
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        <span th:text="${#temporals.format(chat.lastActivityAt, 'dd/MM/yyyy HH:mm')}">Date</span>
                                    </small>
                                    <small class="text-muted" th:if="${chat.assignedAdminName}">
                                        <i class="fas fa-user me-1"></i>
                                        <span th:text="${chat.assignedAdminName}">Admin assigné</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Message si aucune conversation -->
            <div class="col-12" th:if="${chats == null or chats.isEmpty()}">
                <div class="text-center py-5">
                    <i class="fas fa-comments fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">Aucune conversation trouvée</h4>
                    <p class="text-muted">Il n'y a pas de conversations correspondant aux critères sélectionnés.</p>
                </div>
            </div>
        </div>

        <!-- Pagination -->
        <nav aria-label="Navigation des conversations" th:if="${totalPages > 1}">
            <ul class="pagination justify-content-center">
                <li class="page-item" th:classappend="${!hasPrevious} ? 'disabled'">
                    <a class="page-link" th:href="@{/admin/chat(page=${currentPage - 1}, size=${pageSize}, status=${selectedStatus})}">
                        <i class="fas fa-chevron-left"></i> Précédent
                    </a>
                </li>
                
                <li class="page-item" th:each="pageNum : ${#numbers.sequence(0, totalPages - 1)}"
                    th:classappend="${pageNum == currentPage} ? 'active'">
                    <a class="page-link" th:href="@{/admin/chat(page=${pageNum}, size=${pageSize}, status=${selectedStatus})}"
                       th:text="${pageNum + 1}">1</a>
                </li>
                
                <li class="page-item" th:classappend="${!hasNext} ? 'disabled'">
                    <a class="page-link" th:href="@{/admin/chat(page=${currentPage + 1}, size=${pageSize}, status=${selectedStatus})}">
                        Suivant <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            </ul>
        </nav>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Fonction pour voir une conversation
        function viewConversation(chatId) {
            window.location.href = `/admin/chat/${chatId}`;
        }

        // Recherche en temps réel
        document.getElementById('search').addEventListener('input', function() {
            const keyword = this.value.trim();
            if (keyword.length > 2) {
                searchConversations(keyword);
            } else if (keyword.length === 0) {
                location.reload();
            }
        });

        // Fonction de recherche AJAX
        async function searchConversations(keyword) {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const conversationsList = document.getElementById('conversationsList');
            
            try {
                loadingIndicator.style.display = 'block';
                conversationsList.style.display = 'none';
                
                const response = await fetch(`/admin/chat/api/search?keyword=${encodeURIComponent(keyword)}`);
                const data = await response.json();
                
                if (data.success) {
                    updateConversationsList(data.chats);
                } else {
                    showError('Erreur lors de la recherche: ' + data.error);
                }
            } catch (error) {
                showError('Erreur de connexion: ' + error.message);
            } finally {
                loadingIndicator.style.display = 'none';
                conversationsList.style.display = 'block';
            }
        }

        // Mettre à jour la liste des conversations
        function updateConversationsList(chats) {
            const conversationsList = document.getElementById('conversationsList');
            if (chats.length === 0) {
                conversationsList.innerHTML = `
                    <div class="col-12">
                        <div class="text-center py-5">
                            <i class="fas fa-search fa-4x text-muted mb-3"></i>
                            <h4 class="text-muted">Aucun résultat trouvé</h4>
                            <p class="text-muted">Aucune conversation ne correspond à votre recherche.</p>
                        </div>
                    </div>
                `;
                return;
            }

            // Générer le HTML pour les conversations trouvées
            let html = '<div class="col-12"><div class="row">';
            chats.forEach(chat => {
                const statusClass = `status-${chat.status}`;
                const statusBadge = getStatusBadge(chat.status);
                const priorityIcon = getPriorityIcon(chat.priority);
                const unreadBadge = chat.hasUnreadMessages ? '<span class="badge unread-badge ms-1"><i class="fas fa-circle"></i></span>' : '';
                
                html += `
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card chat-card h-100 ${statusClass}" onclick="viewConversation('${chat.id}')">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">${chat.subject}</h6>
                                <div>
                                    ${statusBadge}
                                    ${unreadBadge}
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-8">
                                        <p class="card-text">
                                            <strong>Employé:</strong> ${chat.userName}<br>
                                            <strong>Email:</strong> ${chat.userEmail}<br>
                                            <strong>Département:</strong> ${chat.userDepartment}<br>
                                            <strong>Location:</strong> ${chat.userLocation}
                                        </p>
                                    </div>
                                    <div class="col-4 text-end">
                                        ${priorityIcon}
                                        <br><br>
                                        <small class="text-muted">
                                            <i class="fas fa-envelope me-1"></i>${chat.messageCount}
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <div class="d-flex justify-content-between align-items-center">
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>
                                        ${formatDate(chat.lastActivityAt)}
                                    </small>
                                    ${chat.assignedAdminName ? `<small class="text-muted"><i class="fas fa-user me-1"></i>${chat.assignedAdminName}</small>` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div></div>';
            conversationsList.innerHTML = html;
        }

        // Fonctions utilitaires
        function getStatusBadge(status) {
            const badges = {
                'open': '<span class="badge bg-warning text-dark">Ouvert</span>',
                'in_progress': '<span class="badge bg-primary">En cours</span>',
                'closed': '<span class="badge bg-success">Fermé</span>'
            };
            return badges[status] || '<span class="badge bg-secondary">Inconnu</span>';
        }

        function getPriorityIcon(priority) {
            const icons = {
                'high': '<i class="fas fa-flag priority-high" title="Priorité élevée"></i>',
                'medium': '<i class="fas fa-flag priority-medium" title="Priorité moyenne"></i>',
                'low': '<i class="fas fa-flag priority-low" title="Priorité basse"></i>'
            };
            return icons[priority] || '<i class="fas fa-flag text-muted"></i>';
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('fr-FR') + ' ' + date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
        }

        function showError(message) {
            // Créer ou mettre à jour l'alerte d'erreur
            let errorDiv = document.querySelector('.alert-danger');
            if (!errorDiv) {
                errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger';
                errorDiv.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>';
                document.querySelector('.container-fluid').insertBefore(errorDiv, document.querySelector('.row'));
            }
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i>${message}`;
            errorDiv.style.display = 'block';
            
            // Masquer après 5 secondes
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Auto-refresh toutes les 30 secondes
        setInterval(() => {
            const searchInput = document.getElementById('search');
            if (!searchInput.value.trim()) {
                location.reload();
            }
        }, 30000);
    </script>
</body>
</html>
