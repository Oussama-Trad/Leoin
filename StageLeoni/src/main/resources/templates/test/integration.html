<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle}">Test d'Intégration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-section {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 2rem;
            background: #f8f9fa;
        }
        .test-header {
            background: #007bff;
            color: white;
            padding: 1rem;
            border-radius: 8px 8px 0 0;
            margin: 0;
        }
        .test-body {
            padding: 1.5rem;
        }
        .result-box {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1rem;
            margin-top: 1rem;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { border-left: 4px solid #28a745; }
        .error { border-left: 4px solid #dc3545; }
        .loading { border-left: 4px solid #ffc107; }
        
        .admin-credentials {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .json-display {
            background: #2d3748;
            color: #e2e8f0;
            border-radius: 4px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-cogs"></i> Test d'Intégration - Système de Filtrage
                </h1>
                <p class="lead">
                    Cette page permet de tester l'intégration complète entre Spring Boot et l'API Flask pour le système de filtrage par département/location.
                </p>
            </div>
        </div>

        <!-- Section 1: Informations de test -->
        <div class="test-section">
            <h3 class="test-header">
                <i class="fas fa-info-circle"></i> Informations de Test
            </h3>
            <div class="test-body">
                <div class="admin-credentials">
                    <h5><i class="fas fa-key"></i> Identifiants de Test Disponibles</h5>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Admin IT Messadine:</strong><br>
                            <code>Username: oussama.trad</code><br>
                            <code>Password: test123</code><br>
                            <small class="text-muted">Département: IT, Location: Messadine</small>
                        </div>
                        <div class="col-md-6">
                            <strong>Admin Fallback:</strong><br>
                            <code>Username: admin</code><br>
                            <code>Password: admin</code><br>
                            <small class="text-muted">Admin local (fallback)</small>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-3">
                        <button class="btn btn-info w-100" onclick="loadDepartmentsLocations()">
                            <i class="fas fa-building"></i> Départements/Locations
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-success w-100" onclick="testFlaskConnection()">
                            <i class="fas fa-plug"></i> Test Connexion Flask
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-warning w-100" onclick="clearResults()">
                            <i class="fas fa-eraser"></i> Effacer Résultats
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-secondary w-100" onclick="showHelp()">
                            <i class="fas fa-question-circle"></i> Aide
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Section 2: Test d'authentification -->
        <div class="test-section">
            <h3 class="test-header">
                <i class="fas fa-user-lock"></i> Test d'Authentification
            </h3>
            <div class="test-body">
                <form id="authForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="username" class="form-label">Nom d'utilisateur</label>
                                <input type="text" class="form-control" id="username" value="oussama.trad" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="password" class="form-label">Mot de passe</label>
                                <input type="password" class="form-control" id="password" value="test123" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <button type="button" class="btn btn-primary w-100" onclick="testAuthentication()">
                                <i class="fas fa-sign-in-alt"></i> Test Authentification
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-success w-100" onclick="testFullScenario()">
                                <i class="fas fa-rocket"></i> Scénario Complet
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-info w-100" onclick="useAdminCredentials()">
                                <i class="fas fa-user-cog"></i> Admin Fallback
                            </button>
                        </div>
                    </div>
                </form>
                <div id="authResult" class="result-box" style="display: none;"></div>
            </div>
        </div>

        <!-- Section 3: Test de filtrage des employés -->
        <div class="test-section">
            <h3 class="test-header">
                <i class="fas fa-users"></i> Test Filtrage des Employés
            </h3>
            <div class="test-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="filterDepartment" class="form-label">Département</label>
                            <select class="form-select" id="filterDepartment">
                                <option value="">Tous</option>
                                <option value="IT">IT</option>
                                <option value="Production">Production</option>
                                <option value="Sales">Sales</option>
                                <option value="Marketing">Marketing</option>
                                <option value="HR">HR</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="filterLocation" class="form-label">Location</label>
                            <select class="form-select" id="filterLocation">
                                <option value="">Toutes</option>
                                <option value="Messadine">Messadine</option>
                                <option value="Mateur">Mateur</option>
                                <option value="Manzel Hayet">Manzel Hayet</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="filterRole" class="form-label">Rôle</label>
                            <select class="form-select" id="filterRole">
                                <option value="">Auto</option>
                                <option value="ADMIN">ADMIN</option>
                                <option value="SUPERADMIN">SUPERADMIN</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">&nbsp;</label>
                            <button type="button" class="btn btn-success w-100" onclick="testFilteredEmployees()">
                                <i class="fas fa-filter"></i> Filtrer Employés
                            </button>
                        </div>
                    </div>
                </div>
                <div id="employeesResult" class="result-box" style="display: none;"></div>
            </div>
        </div>

        <!-- Section 4: Test de création d'actualité -->
        <div class="test-section">
            <h3 class="test-header">
                <i class="fas fa-newspaper"></i> Test Création d'Actualité
            </h3>
            <div class="test-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="newsTitle" class="form-label">Titre</label>
                            <input type="text" class="form-control" id="newsTitle" value="Test d'actualité filtrée">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="newsContent" class="form-label">Contenu</label>
                            <textarea class="form-control" id="newsContent" rows="2">Ceci est un test de création d'actualité avec ciblage par département et location.</textarea>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="newsDepartments" class="form-label">Départements Ciblés</label>
                            <select class="form-select" id="newsDepartments" multiple>
                                <option value="IT">IT</option>
                                <option value="Production">Production</option>
                                <option value="Sales">Sales</option>
                            </select>
                            <small class="text-muted">Maintenez Ctrl pour sélectionner plusieurs</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="newsLocations" class="form-label">Locations Ciblées</label>
                            <select class="form-select" id="newsLocations" multiple>
                                <option value="Messadine">Messadine</option>
                                <option value="Mateur">Mateur</option>
                                <option value="Manzel Hayet">Manzel Hayet</option>
                            </select>
                            <small class="text-muted">Maintenez Ctrl pour sélectionner plusieurs</small>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-primary" onclick="testCreateNews()">
                    <i class="fas fa-plus"></i> Créer Actualité Test
                </button>
                <div id="newsResult" class="result-box" style="display: none;"></div>
            </div>
        </div>

        <!-- Section 5: Résultats globaux -->
        <div class="test-section">
            <h3 class="test-header">
                <i class="fas fa-chart-line"></i> Résultats et Logs
            </h3>
            <div class="test-body">
                <div id="globalResults" class="result-box">
                    <p class="text-muted mb-0">Les résultats des tests s'afficheront ici...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentToken = null;
        let authData = null;

        function log(message, type = 'info') {
            const globalResults = document.getElementById('globalResults');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'times-circle' : 'info-circle';
            const colorClass = type === 'success' ? 'text-success' : type === 'error' ? 'text-danger' : 'text-info';
            
            globalResults.innerHTML += `
                <div class="d-flex align-items-center mb-2">
                    <i class="fas fa-${icon} ${colorClass} me-2"></i>
                    <span class="text-muted me-2">[${timestamp}]</span>
                    <span>${message}</span>
                </div>
            `;
            globalResults.scrollTop = globalResults.scrollHeight;
        }

        function clearResults() {
            document.getElementById('globalResults').innerHTML = '<p class="text-muted mb-0">Résultats effacés...</p>';
            ['authResult', 'employeesResult', 'newsResult'].forEach(id => {
                const element = document.getElementById(id);
                element.style.display = 'none';
                element.innerHTML = '';
            });
            currentToken = null;
            authData = null;
        }

        function showResult(elementId, data, success = true) {
            const element = document.getElementById(elementId);
            element.className = `result-box ${success ? 'success' : 'error'}`;
            element.innerHTML = `<div class="json-display">${JSON.stringify(data, null, 2)}</div>`;
            element.style.display = 'block';
        }

        function useAdminCredentials() {
            document.getElementById('username').value = 'admin';
            document.getElementById('password').value = 'admin';
            log('Identifiants admin fallback remplis');
        }

        async function testAuthentication() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                log('Nom d\'utilisateur et mot de passe requis', 'error');
                return;
            }

            log(`Test d'authentification pour: ${username}`);

            try {
                const response = await fetch('/test/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                showResult('authResult', data, data.success);

                if (data.success && data.authResponse) {
                    currentToken = data.authResponse.flaskToken || data.authResponse.token;
                    authData = data.authResponse;
                    log(`Authentification réussie - Token: ${data.authResponse.flaskToken ? 'Flask JWT' : 'Local'}`, 'success');
                } else {
                    log(`Échec authentification: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`Erreur authentification: ${error.message}`, 'error');
                showResult('authResult', { error: error.message }, false);
            }
        }

        async function testFilteredEmployees() {
            if (!currentToken) {
                log('Veuillez d\'abord vous authentifier', 'error');
                return;
            }

            const department = document.getElementById('filterDepartment').value;
            const location = document.getElementById('filterLocation').value;
            const role = document.getElementById('filterRole').value;

            log(`Test filtrage employés - Dept: ${department || 'ALL'}, Loc: ${location || 'ALL'}, Role: ${role || 'AUTO'}`);

            try {
                const response = await fetch('/test/employees', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: currentToken,
                        department,
                        location,
                        role
                    })
                });

                const data = await response.json();
                showResult('employeesResult', data, data.success);

                if (data.success) {
                    log(`Employés récupérés: ${data.count} employés trouvés`, 'success');
                } else {
                    log(`Erreur filtrage: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`Erreur filtrage employés: ${error.message}`, 'error');
                showResult('employeesResult', { error: error.message }, false);
            }
        }

        async function testCreateNews() {
            if (!currentToken) {
                log('Veuillez d\'abord vous authentifier', 'error');
                return;
            }

            const title = document.getElementById('newsTitle').value;
            const content = document.getElementById('newsContent').value;
            const departments = Array.from(document.getElementById('newsDepartments').selectedOptions).map(opt => opt.value);
            const locations = Array.from(document.getElementById('newsLocations').selectedOptions).map(opt => opt.value);

            log(`Test création actualité: "${title}"`);

            try {
                const response = await fetch('/test/news', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        token: currentToken,
                        title,
                        content,
                        targetDepartments: departments,
                        targetLocations: locations
                    })
                });

                const data = await response.json();
                showResult('newsResult', data, data.success);

                if (data.success) {
                    log('Actualité créée avec succès', 'success');
                } else {
                    log(`Erreur création actualité: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`Erreur création actualité: ${error.message}`, 'error');
                showResult('newsResult', { error: error.message }, false);
            }
        }

        async function testFullScenario() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            if (!username || !password) {
                log('Nom d\'utilisateur et mot de passe requis pour le scénario complet', 'error');
                return;
            }

            log('🚀 Lancement du scénario complet...');

            try {
                const response = await fetch('/test/full-scenario', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();
                showResult('authResult', data, data.success);

                if (data.success) {
                    log('✅ Scénario complet réussi!', 'success');
                    currentToken = data.results.authentication.tokenType === 'Flask JWT' ? 'flask-token' : 'local-token';
                } else {
                    log(`❌ Échec scénario: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`Erreur scénario complet: ${error.message}`, 'error');
                showResult('authResult', { error: error.message }, false);
            }
        }

        async function loadDepartmentsLocations() {
            log('Chargement des départements et locations...');

            try {
                const response = await fetch('/test/departments-locations');
                const data = await response.json();

                if (data.success) {
                    log(`Départements/Locations chargés: ${JSON.stringify(data.data)}`, 'success');
                } else {
                    log(`Erreur chargement: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`Erreur chargement départements/locations: ${error.message}`, 'error');
            }
        }

        function testFlaskConnection() {
            log('Test de connexion Flask via Spring Boot...');
            fetch('/test/departments-locations')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        log('✅ Connexion Flask OK via Spring Boot', 'success');
                    } else {
                        log('❌ Connexion Flask échouée', 'error');
                    }
                })
                .catch(error => {
                    log(`❌ Erreur connexion Flask: ${error.message}`, 'error');
                });
        }

        function showHelp() {
            log(`
📖 AIDE - Comment utiliser cette page de test:

1. 🔐 AUTHENTIFICATION:
   - Utilisez "oussama.trad / test123" pour un admin IT Messadine
   - Ou "admin / admin" pour l'admin fallback local
   - Cliquez "Test Authentification" ou "Scénario Complet"

2. 👥 FILTRAGE EMPLOYÉS:
   - Après authentification, testez le filtrage par département/location
   - Les ADMIN voient seulement leur scope
   - Les SUPERADMIN peuvent filtrer librement

3. 📰 ACTUALITÉS:
   - Créez une actualité avec ciblage spécifique
   - Les ADMIN sont limités à leur département/location

4. 🚀 SCÉNARIO COMPLET:
   - Teste toute la chaîne d'intégration en une fois
   - Authentification + Filtrage + Données

⚡ Les résultats s'affichent en temps réel dans cette section.
            `);
        }

        // Initialisation
        log('Page de test chargée - Prête pour les tests d\'intégration');
    </script>
</body>
</html>
