<!DOCTYPE html>
<html lang="fr" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LEONI Admin Dashboard</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --leoni-blue: #1e3c72;
            --leoni-light-blue: #2a5298;
            --leoni-accent: #667eea;
            --sidebar-width: 260px;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: var(--sidebar-width);
            background: linear-gradient(135deg, var(--leoni-blue) 0%, var(--leoni-light-blue) 100%);
            color: white;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        
        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .sidebar-brand {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            text-decoration: none;
        }
        
        .nav-menu {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }
        
        .nav-menu li {
            margin-bottom: 0.25rem;
        }
        
        .nav-menu a {
            display: flex;
            align-items: center;
            padding: 1rem 1.5rem;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s ease;
        }
        
        .nav-menu a:hover,
        .nav-menu a.active {
            background: rgba(255,255,255,0.1);
            color: white;
            border-right: 3px solid var(--leoni-accent);
        }
        
        .nav-menu i {
            margin-right: 0.75rem;
            width: 1.25rem;
        }
        
        /* Main content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: 2rem;
        }
        
        /* Header */
        .page-header {
            background: white;
            padding: 1.5rem 2rem;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--leoni-blue), var(--leoni-accent));
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--leoni-blue);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        .stat-icon {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            font-size: 2rem;
            color: var(--leoni-accent);
            opacity: 0.3;
        }
        
        /* Content Cards */
        .content-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .card-header-custom {
            background: linear-gradient(135deg, var(--leoni-blue), var(--leoni-light-blue));
            color: white;
            padding: 1.5rem;
            border: none;
        }
        
        .card-body-custom {
            padding: 1.5rem;
        }
        
        /* User info */
        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--leoni-accent), var(--leoni-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.25rem;
        }
        
        .role-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        
        .role-superadmin {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
        }
        
        .role-admin {
            background: linear-gradient(135deg, #4ecdc4, #44a08d);
            color: white;
        }
        
        /* Activity list */
        .activity-item {
            padding: 1rem;
            border-left: 3px solid var(--leoni-accent);
            background: #f8f9fa;
            margin-bottom: 1rem;
            border-radius: 0 10px 10px 0;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 0;
                overflow: hidden;
                transition: width 0.3s ease;
            }
            
            .sidebar.show {
                width: var(--sidebar-width);
            }
            
            .main-content {
                margin-left: 0;
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
        
        /* Error message */
        .error-message {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        
        /* Loading spinner */
        .loading-spinner {
            text-align: center;
            padding: 2rem;
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--leoni-blue);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <a href="#" class="sidebar-brand">
                <i class="fas fa-cube me-2"></i>
                LEONI Admin
            </a>
        </div>
        
        <nav>
            <ul class="nav-menu">
                <li><a href="#dashboard" class="nav-link active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Tableau de bord</span>
                </a></li>
                <li><a href="#employees" class="nav-link" data-section="employees">
                    <i class="fas fa-users"></i>
                    <span>Employ√©s</span>
                </a></li>
                <li><a href="#news" class="nav-link" data-section="news">
                    <i class="fas fa-newspaper"></i>
                    <span>Actualit√©s</span>
                </a></li>
                <li><a href="#documents" class="nav-link" data-section="documents">
                    <i class="fas fa-file-alt"></i>
                    <span>Documents</span>
                </a></li>
                <li><a href="#chats" class="nav-link" data-section="chats">
                    <i class="fas fa-comments"></i>
                    <span>Conversations</span>
                </a></li>
                <li><a href="/admin/chat" class="nav-link">
                    <i class="fas fa-comments-dollar"></i>
                    <span>Interface Chat Compl√®te</span>
                </a></li>
                <li th:if="${isSuperAdmin}"><a href="#admin-management" class="nav-link" data-section="admin-management">
                    <i class="fas fa-user-cog"></i>
                    <span>Gestion Admins</span>
                </a></li>
            </ul>
        </nav>
        
        <div class="mt-auto p-3">
            <button class="btn btn-outline-light w-100" onclick="logout()">
                <i class="fas fa-sign-out-alt me-2"></i>
                D√©connexion
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Mobile menu toggle -->
        <button class="btn btn-primary d-md-none mb-3" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Error Message -->
        <div th:if="${error}" class="error-message">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span th:text="${error}">Erreur</span>
        </div>

        <!-- Page Header -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-1">
                        <span th:if="${isSuperAdmin}">üõ°Ô∏è SuperAdmin</span>
                        <span th:unless="${isSuperAdmin}">üë®‚Äçüíº Admin</span>
                        Dashboard
                    </h1>
                    <p class="text-muted mb-0">Bienvenue dans votre espace d'administration LEONI</p>
                </div>
                <div class="user-info">
                    <div class="user-avatar" th:text="${#strings.substring(username ?: 'U', 0, 1).toUpperCase()}">U</div>
                    <div>
                        <div class="fw-bold" th:text="${username ?: 'Utilisateur'}">Utilisateur</div>
                        <div>
                            <span th:if="${isSuperAdmin}" class="role-badge role-superadmin">SUPERADMIN</span>
                            <span th:unless="${isSuperAdmin}" class="role-badge role-admin">ADMIN</span>
                        </div>
                        <small class="text-muted" th:if="${department != null or location != null}">
                            <span th:if="${department != null}" th:text="${department}">D√©partement</span>
                            <span th:if="${department != null and location != null}"> - </span>
                            <span th:if="${location != null}" th:text="${location}">Localisation</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section">
            <!-- Statistics Cards -->
            <div class="stats-grid">
                <div class="stat-card" th:if="${isSuperAdmin}">
                    <div class="stat-number" th:text="${totalAdmins ?: 0}">0</div>
                    <div class="stat-label">Total Admins</div>
                    <i class="fas fa-user-cog stat-icon"></i>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" th:text="${totalEmployees ?: 0}">0</div>
                    <div class="stat-label">
                        <span th:if="${isSuperAdmin}">Total Employ√©s</span>
                        <span th:unless="${isSuperAdmin}">Employ√©s</span>
                    </div>
                    <i class="fas fa-users stat-icon"></i>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" th:text="${totalNews ?: 0}">0</div>
                    <div class="stat-label">Actualit√©s</div>
                    <i class="fas fa-newspaper stat-icon"></i>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" th:text="${activeChats ?: 0}">0</div>
                    <div class="stat-label">Conversations Actives</div>
                    <i class="fas fa-comments stat-icon"></i>
                </div>
                
                <div class="stat-card">
                    <div class="stat-number" th:text="${pendingRequests ?: 0}">0</div>
                    <div class="stat-label">Demandes en Attente</div>
                    <i class="fas fa-clock stat-icon"></i>
                </div>
                
                <div class="stat-card" th:if="${isSuperAdmin}">
                    <div class="stat-number" th:text="${totalDepartments ?: 0}">0</div>
                    <div class="stat-label">D√©partements</div>
                    <i class="fas fa-building stat-icon"></i>
                </div>
            </div>
            
            <!-- Section Conversations dans le dashboard -->
            <div class="content-card mb-4">
                <div class="card-header-custom">
                    <h5 class="mb-0">
                        <i class="fas fa-comments me-2"></i>
                        Conversations R√©centes
                    </h5>
                </div>
                <div class="card-body-custom">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span>Conversations ouvertes</span>
                                <span class="badge bg-success" id="openChatsCount">0</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span>En cours de traitement</span>
                                <span class="badge bg-warning" id="inProgressChatsCount">0</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span>Messages non lus</span>
                                <span class="badge bg-danger" id="unreadChatsCount">0</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-grid gap-2">
                                <a th:href="@{/admin/chat(token=${token})}" class="btn btn-primary">
                                    <i class="fas fa-comments me-2"></i>
                                    Interface Chat Compl√®te
                                </a>
                                <button class="btn btn-outline-primary" onclick="loadChatPreview()">
                                    <i class="fas fa-eye me-2"></i>
                                    Aper√ßu Conversations
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class="content-card">
                <div class="card-header-custom">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>
                        Activit√© R√©cente
                    </h5>
                </div>
                <div class="card-body-custom">
                    <div th:if="${recentActivity != null && !recentActivity.isEmpty()}">
                        <div th:each="activity : ${recentActivity}" class="activity-item">
                            <div class="d-flex align-items-center">
                                <i class="fas fa-circle me-3" style="font-size: 0.5rem; color: var(--leoni-accent);"></i>
                                <div class="flex-grow-1">
                                    <div th:text="${activity.title}">Activit√©</div>
                                    <small class="text-muted" th:if="${activity.date != null}" 
                                           th:text="${activity.date}">
                                        Date
                                    </small>
                                </div>
                                <span class="badge bg-primary" th:text="${activity.type}">Type</span>
                            </div>
                        </div>
                    </div>
                    <div th:if="${recentActivity == null || recentActivity.isEmpty()}" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>Aucune activit√© r√©cente</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Other sections will be loaded dynamically -->
        <div id="dynamic-content" style="display: none;">
            <div class="loading-spinner">
                <div class="spinner"></div>
                <p class="mt-3">Chargement...</p>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Variables globales
        const authToken = '[[${token}]]';
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard initialized');
            
            // Setup navigation
            setupNavigation();
            
            // Charger les statistiques de chat
            loadChatStatistics();
            
            // Auto-refresh stats every 5 minutes
            setInterval(refreshStats, 5 * 60 * 1000);
        });
        
        // Navigation handling
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Remove active class from all links
                    navLinks.forEach(l => l.classList.remove('active'));
                    
                    // Add active class to clicked link
                    this.classList.add('active');
                    
                    const section = this.dataset.section;
                    loadSection(section);
                });
            });
        }
        
        // Load section content
        async function loadSection(section) {
            console.log('Loading section:', section);
            
            if (section === 'dashboard') {
                document.getElementById('dashboard-section').style.display = 'block';
                document.getElementById('dynamic-content').style.display = 'none';
                return;
            }
            
            // Redirection vers l'interface chat compl√®te
            if (section === 'chats') {
                window.location.href = `/admin/chat?token=${encodeURIComponent(authToken)}`;
                return;
            }
            
            document.getElementById('dashboard-section').style.display = 'none';
            document.getElementById('dynamic-content').style.display = 'block';
            
            try {
                // Show loading
                document.getElementById('dynamic-content').innerHTML = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <p class="mt-3">Chargement de ${getSectionTitle(section)}...</p>
                    </div>
                `;
                
                // Load section content using our new API endpoints
                await loadSectionContent(section);
                
            } catch (error) {
                console.error('Error loading section:', error);
                document.getElementById('dynamic-content').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erreur lors du chargement de la section
                    </div>
                `;
            }
        }
        
        // Get section title
        function getSectionTitle(section) {
            const titles = {
                'employees': 'Gestion des Employ√©s',
                'news': 'Gestion des Actualit√©s',
                'documents': 'Gestion des Documents',
                'chats': 'Conversations',
                'admin-management': 'Gestion des Admins'
            };
            return titles[section] || section;
        }
        
        // Get section icon
        function getSectionIcon(section) {
            const icons = {
                'employees': 'fa-users',
                'news': 'fa-newspaper',
                'documents': 'fa-file-alt',
                'chats': 'fa-comments',
                'admin-management': 'fa-user-cog'
            };
            return icons[section] || 'fa-folder';
        }
        
        // Load actual section content using our API endpoints
        async function loadSectionContent(section) {
            if (!authToken) {
                document.getElementById('dynamic-content').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Token d'authentification manquant
                    </div>
                `;
                return;
            }
            
            try {
                let apiEndpoint;
                let dataKey;
                
                switch(section) {
                    case 'employees':
                        apiEndpoint = '/dashboard/api/employees';
                        dataKey = 'employees';
                        break;
                    case 'news':
                        apiEndpoint = '/api/news-management';
                        dataKey = 'news';
                        break;
                    case 'documents':
                        apiEndpoint = '/api/sync/documents';
                        dataKey = 'requests';
                        break;
                    case 'admin-management':
                        // Admin management would go here when implemented
                        showComingSoon(section);
                        return;
                    default:
                        showComingSoon(section);
                        return;
                }
                
                // Fetch data from API
                const response = await fetch(apiEndpoint + '?page=0&size=10', {
                    headers: {
                        'Authorization': 'Bearer ' + authToken,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.message || 'Erreur lors du chargement des donn√©es');
                }
                
                // Generate table content
                renderSectionTable(section, data[dataKey] || [], data);
                
            } catch (error) {
                console.error('Error loading section content:', error);
                document.getElementById('dynamic-content').innerHTML = `
                    <div class="content-card">
                        <div class="card-header-custom">
                            <h5 class="mb-0">
                                <i class="fas ${getSectionIcon(section)} me-2"></i>
                                ${getSectionTitle(section)}
                            </h5>
                        </div>
                        <div class="card-body-custom">
                            <div class="error-message">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Erreur: ${error.message}
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        // Show coming soon message for sections not yet implemented
        function showComingSoon(section) {
            document.getElementById('dynamic-content').innerHTML = `
                <div class="content-card">
                    <div class="card-header-custom">
                        <h5 class="mb-0">
                            <i class="fas ${getSectionIcon(section)} me-2"></i>
                            ${getSectionTitle(section)}
                        </h5>
                    </div>
                    <div class="card-body-custom">
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-tools fa-3x mb-3 text-secondary"></i>
                            <h5>Section en d√©veloppement</h5>
                            <p>Cette fonctionnalit√© sera bient√¥t disponible.</p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Render data table for different sections
        function renderSectionTable(section, items, fullData) {
            let tableHeaders = '';
            let tableRows = '';
            
            switch(section) {
                case 'employees':
                    tableHeaders = `
                        <th>Nom</th>
                        <th>Email</th>
                        <th>D√©partement</th>
                        <th>Position</th>
                        <th>Statut</th>
                        <th>Actions</th>
                    `;
                    tableRows = items.map(employee => `
                        <tr>
                            <td>${employee.firstName || ''} ${employee.lastName || ''}</td>
                            <td>${employee.email || '-'}</td>
                            <td>${employee.department || '-'}</td>
                            <td>${employee.position || '-'}</td>
                            <td>
                                <span class="badge bg-${employee.status === 'approved' ? 'success' : employee.status === 'pending' ? 'warning' : 'danger'}">
                                    ${employee.status || 'unknown'}
                                </span>
                            </td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" title="Voir d√©tails">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    break;
                    
                case 'chats':
                    tableHeaders = `
                        <th>Sujet</th>
                        <th>Utilisateur</th>
                        <th>Statut</th>
                        <th>Messages</th>
                        <th>Derni√®re activit√©</th>
                        <th>Actions</th>
                    `;
                    tableRows = items.map(chat => `
                        <tr>
                            <td>${chat.subject || '-'}</td>
                            <td>${chat.userName || '-'}</td>
                            <td>
                                <span class="badge bg-${chat.status === 'open' ? 'success' : chat.status === 'in_progress' ? 'warning' : 'secondary'}">
                                    ${chat.status || 'unknown'}
                                </span>
                            </td>
                            <td>${chat.messageCount || 0}</td>
                            <td>${chat.lastActivityAt ? new Date(chat.lastActivityAt).toLocaleDateString('fr-FR') : '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" title="Voir conversation">
                                    <i class="fas fa-comments"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    break;
                    
                case 'news':
                    tableHeaders = `
                        <th>Titre</th>
                        <th>Auteur</th>
                        <th>Cat√©gorie</th>
                        <th>Priorit√©</th>
                        <th>Date</th>
                        <th>Actions</th>
                    `;
                    tableRows = items.map(newsItem => `
                        <tr>
                            <td>${newsItem.title || '-'}</td>
                            <td>${newsItem.authorName || '-'}</td>
                            <td>${newsItem.category || '-'}</td>
                            <td>
                                <span class="badge bg-${newsItem.priority === 'urgent' ? 'danger' : newsItem.priority === 'high' ? 'warning' : 'primary'}">
                                    ${newsItem.priority || 'normal'}
                                </span>
                            </td>
                            <td>${newsItem.createdAt ? new Date(newsItem.createdAt).toLocaleDateString('fr-FR') : '-'}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-primary" title="Voir d√©tails">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `).join('');
                    break;
            }
            
            const pagination = fullData.totalPages > 1 ? `
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <small class="text-muted">Affichage de ${items.length} sur ${fullData.totalElements} √©l√©ments</small>
                    <div>
                        Page ${fullData.currentPage + 1} sur ${fullData.totalPages}
                    </div>
                </div>
            ` : '';
            
            document.getElementById('dynamic-content').innerHTML = `
                <div class="content-card">
                    <div class="card-header-custom">
                        <h5 class="mb-0">
                            <i class="fas ${getSectionIcon(section)} me-2"></i>
                            ${getSectionTitle(section)}
                        </h5>
                    </div>
                    <div class="card-body-custom">
                        ${items.length > 0 ? `
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            ${tableHeaders}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${tableRows}
                                    </tbody>
                                </table>
                                ${pagination}
                            </div>
                        ` : `
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <h5>Aucun √©l√©ment</h5>
                                <p>Aucun √©l√©ment trouv√© dans cette section.</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }
        
        // Refresh dashboard stats
        async function refreshStats() {
            try {
                if (!authToken) return;
                
                const response = await fetch('/dashboard/api/stats', {
                    headers: {
                        'Authorization': 'Bearer ' + authToken
                    }
                });
                
                if (response.ok) {
                    const stats = await response.json();
                    if (stats.success) {
                        updateStatsDisplay(stats);
                    }
                }
            } catch (error) {
                console.error('Error refreshing stats:', error);
            }
        }
        
        // Charger les statistiques de chat
        async function loadChatStatistics() {
            try {
                const response = await fetch('/api/sync/statistics', {
                    headers: {
                        'Authorization': 'Bearer ' + authToken,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.chatStatistics) {
                        updateChatStatistics(data.chatStatistics);
                    }
                }
            } catch (error) {
                console.error('Erreur chargement statistiques chat:', error);
            }
        }
        
        // Mettre √† jour les statistiques de chat
        function updateChatStatistics(chatStats) {
            const elements = {
                'openChatsCount': chatStats.openConversations || 0,
                'inProgressChatsCount': chatStats.inProgressConversations || 0,
                'unreadChatsCount': chatStats.unreadConversations || 0
            };
            
            Object.entries(elements).forEach(([elementId, value]) => {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = value;
                }
            });
        }
        
        // Charger l'aper√ßu des conversations
        async function loadChatPreview() {
            try {
                const response = await fetch('/api/sync/chats?page=0&size=5', {
                    headers: {
                        'Authorization': 'Bearer ' + authToken,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        displayChatPreview(data.conversations);
                    }
                }
            } catch (error) {
                console.error('Erreur chargement aper√ßu chat:', error);
            }
        }
        
        // Afficher l'aper√ßu des conversations
        function displayChatPreview(conversations) {
            if (!conversations || conversations.length === 0) {
                showAlert('Aucune conversation trouv√©e', 'info');
                return;
            }
            
            let html = '<div class="list-group">';
            conversations.forEach(chat => {
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-1">${chat.subject || 'Sans sujet'}</h6>
                                <small>${chat.userName || 'Utilisateur'} - ${chat.targetDepartment || 'N/A'}</small>
                            </div>
                            <span class="badge bg-${getStatusColor(chat.status)}">${getStatusText(chat.status)}</span>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            // Afficher dans un modal ou une section
            showAlert('Aper√ßu des conversations charg√©', 'success');
        }
        
        function getStatusColor(status) {
            const colors = {
                'open': 'success',
                'in_progress': 'warning',
                'closed': 'secondary'
            };
            return colors[status] || 'primary';
        }
        
        function getStatusText(status) {
            const texts = {
                'open': 'Ouvert',
                'in_progress': 'En cours',
                'closed': 'Ferm√©'
            };
            return texts[status] || status;
        }
        
        // Update stats display
        function updateStatsDisplay(stats) {
            const elements = {
                'totalAdmins': stats.totalAdmins,
                'totalEmployees': stats.totalEmployees,
                'totalNews': stats.totalNews,
                'activeChats': stats.activeChats,
                'pendingRequests': stats.pendingRequests,
                'totalDepartments': stats.totalDepartments,
                'totalLocations': stats.totalLocations
            };
            
            Object.entries(elements).forEach(([key, value]) => {
                const element = document.querySelector(`[data-stat="${key}"]`);
                if (element && value !== undefined) {
                    element.textContent = value;
                }
            });
        }
        
        // Toggle sidebar (mobile)
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }
        
        // Logout function
        function logout() {
            if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
                const token = authToken;
                
                fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + token,
                        'Content-Type': 'application/json'
                    }
                }).finally(() => {
                    // Clear local storage and redirect
                    localStorage.removeItem('token');
                    localStorage.removeItem('username');
                    localStorage.removeItem('role');
                    window.location.href = '/login.html';
                });
            }
        }
        
        // Close sidebar on outside click (mobile)
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const isMobile = window.innerWidth <= 768;
            
            if (isMobile && sidebar.classList.contains('show') && 
                !sidebar.contains(e.target) && !e.target.matches('.fa-bars')) {
                sidebar.classList.remove('show');
            }
        });
        
        // Fonction utilitaire pour afficher des alertes
        function showAlert(message, type = 'info') {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; max-width: 400px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-dismiss apr√®s 5 secondes
            setTimeout(() => {
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(alert => {
                    if (alert.textContent.includes(message)) {
                        alert.remove();
                    }
                });
            }, 5000);
        }
    </script>
</body>
</html>
